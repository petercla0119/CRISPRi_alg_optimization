# Data cleaning and preprocessing functions
# @status: experimental
# @version:
# @author: Claire Peterson
# @contact: cspeters@uab.edu


fix_missing <- function(x, na.value) {
x[x == na.value] <- NA
x
}


#' Separate sgRNA_summary.txt file generated by MAGeCK.
#' 
#' @description The sgRNA summary file generated by MAGeCK contains 'control_count' and 'treatment_count' columns. 
#'              Columns contain the sgRNA counts for each replicate which are separated with '/'. 
#'              Designed for STMN2 screen sgRNA summary file. 
#'                  The STMN2 screen was comprised of 3 paired replicates after sorting (high and low), thus totaling to 6 samples.
#' @param input The path to the sgRNA summary .txt file or the loaded dataframe.              
#' @returns A dataframe with 'control_count' and 'treatment_count' parsed into separate columns.
separate_sgrna_summary <- function(input) {
    
  # Check if input is a file path or dataframe
  if (is.character(input)) {
    # If input is a file path, read the file
    sgrna_summary <- read.delim(input)
  } else if (is.data.frame(input)) {
    # If input is already a dataframe, use it directly
    sgrna_summary <- input
  } else {
    stop("Input must be either a file path or a dataframe.")
  }
  
  # Split the control and treatment counts into individual replicates
  sgrna_summary$control_1 <- sgrna_summary$control_count %>%
    str_split_i("/", 1) %>%
    as.numeric()
  sgrna_summary$control_2 <- sgrna_summary$control_count %>%
    str_split_i("/", 2) %>%
    as.numeric()
  sgrna_summary$control_3 <- sgrna_summary$control_count %>%
    str_split_i("/", 3) %>%
    as.numeric()
  
  sgrna_summary$treatment_1 <- sgrna_summary$treatment_count %>%
    str_split_i("/", 1) %>%
    as.numeric()
  sgrna_summary$treatment_2 <- sgrna_summary$treatment_count %>%
    str_split_i("/", 2) %>%
    as.numeric()
  sgrna_summary$treatment_3 <- sgrna_summary$treatment_count %>%
    str_split_i("/", 3) %>%
    as.numeric()
  
  return(sgrna_summary)
}


#' Calculate mean, standard deviation, and coefficient of variation from sgRNA_summary.txt file generated by MAGeCK.
#' 
#' @description Calculates the mean, standard deviation, and coefficient of variation by sgRNA ID from separated sgRNA summary files.
#'              Intended for further data processing steps directly following the [separate_sgrna_summary(file_path)] function. 
#' @seealso [separate_sgrna_summary(file_path)]
#' @param df A dataframe. Dataframe must have one column for each replicate which contains sgRNA counts for that replicate sample. 
#'            Counts for replicates must be separated into distinct columns per replicate. Function fails to work with raw sgRNA_summary.txt file generated by MAGeCK.
#'            In other words, each replicate must have its own '_count' column.
#' @returns A dataframe with the following additional columns: 
#'          'control_sd', 'treatment_sd', 'pooled_sum_squares', 'cv_low', 'cv_high'
calculate_avg_sd_cv_sgrna_summary <- function(df) {
  # Calculate the averages for control and treatment
  df <- df %>%
    mutate(
      control_avg = (control_1 + control_2 + control_3) / 3,
      treatment_avg = (treatment_1 + treatment_2 + treatment_3) / 3
    )

  # Calculate the standard deviations for control and treatment
  control_sd <- df[c("control_1", "control_2", "control_3")] %>% apply(1, sd)
  df <- cbind(df, control_sd = control_sd)

  treatment_sd <- df[c("treatment_1", "treatment_2", "treatment_3")] %>% apply(1, sd)
  df <- cbind(df, treatment_sd = treatment_sd)

  df <- df %>% mutate(
    pooled_sum_squares = sqrt(control_sd^2 + treatment_sd^2) / (control_avg + treatment_avg),
    cv_low = (control_sd)^2 / (control_avg),
    cv_high = (treatment_sd)^2 / (treatment_avg)
  )

  return(df)
}


# Data visualization -------------------------------------------------------------------------------

#' Plots boxplots of all columns within a df. DF must only contain columns with numeric data.
#' 
#' @description Intended for quick and dirty sense of how data is distributed.
#' @param df A dataframe. Dataframe columns must only consist of numeric values.
#' @returns A single plot displaying boxplots for all numeric columns.
#' @examples 
# TODO: add examples for function
plot_all_boxplots <- function(df) {
  # Ensure the data frame is in the correct format
  if (!is.data.frame(df)) {
    stop("Input must be a data frame.")
  }
  
  # Convert the data frame to a long format
  df_long <- df %>%
    tidyr::pivot_longer(cols = everything(), names_to = "variable", values_to = "value")
  
  # Plot boxplots for all columns
  p <- ggplot(df_long, aes(x = variable, y = value)) +
    geom_boxplot() +
    labs(title = "Boxplots of All Columns",
         x = "Variable",
         y = "Value") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels for readability
  
  # Print the plot
  print(p)
}